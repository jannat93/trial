<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AR Sky ðŸŒŒ</title>
<script src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.min.js"></script>
<style>
html, body {
    margin: 0; padding: 0; width: 100%; height: 100%;
    overflow: hidden; font-family: 'Segoe UI', sans-serif;
    background: radial-gradient(circle at bottom, #000010, #000000);
    color: white;
}
#camera-container { position: relative; width: 100%; height: 100%; }
#camera { position: absolute; width: 100%; height: 100%; object-fit: cover; z-index: 0; display: none; }
#overlay { position: absolute; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
#controls {
    position: absolute; bottom: 15px; width: 100%; display: flex;
    justify-content: center; gap: 10px; z-index: 2;
}
button {
    padding: 12px 18px; font-size: 16px; border-radius: 8px;
    border: 1px solid white; background: rgba(0,0,0,0.6); color: white;
    cursor: pointer; transition: 0.3s;
    /* Add a subtle hover effect and shadow for a better look */
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
}
button:hover { background: rgba(255,255,255,0.2); }
.message-box {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.7); padding: 15px 20px; border-radius: 10px;
    text-align: center; display: none; z-index: 10;
}
</style>
</head>
<body>
<div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
</div>
<div id="controls">
    <button id="startBtn">Start AR ðŸŒŒ</button>
    <button id="toggleBtn" style="display:none;">Toggle Deep Sky</button>
</div>
<div class="message-box" id="msgBox"><p id="msgText"></p></div>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('overlay');
const ctx = canvas.getContext('2d');
// Initial resize
function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();
// Listen for window resize to keep canvas responsive
window.addEventListener('resize', resizeCanvas);

const startBtn = document.getElementById('startBtn');
const toggleBtn = document.getElementById('toggleBtn');
const msgBox = document.getElementById('msgBox');
const msgText = document.getElementById('msgText');

let showDeepSky = true;
let azimuth = 0, altitude = 0;
const fov = 60; // degrees

// Stars (bright stars)
const stars = [
    {name:"Sirius", ra:101.2875, dec:-16.7161, mag:-1.46},
    {name:"Vega", ra:279.2347, dec:38.7837, mag:0.03},
    {name:"Betelgeuse", ra:88.7929, dec:7.4071, mag:0.42},
    {name:"Rigel", ra:78.6345, dec:-8.2016, mag:0.12},
    {name:"Capella", ra:79.1723, dec:45.9979, mag:0.08}
];

// Deep-sky objects (red markers)
const deepSky = [
    {name:"Andromeda Galaxy", ra:10.6847, dec:41.269, size:30},
    {name:"Orion Nebula", ra:83.8016, dec:-5.3916, size:25},
    {name:"Pleiades Cluster", ra:56.75, dec:24.1, size:20},
    {name:"Crab Nebula", ra:83.6331, dec:22.0145, size:15},
    {name:"Milky Way Center", ra:266.4168, dec:-29.0078, size:35}
];

function showMsg(text){
    msgText.textContent=text;
    msgBox.style.display='block';
    setTimeout(()=>msgBox.style.display='none',3000);
}

// Device orientation logic - now with proper iOS permission handling
function handleDeviceOrientation(e) {
    if(e.alpha!==null){
        azimuth = (360 - e.alpha)%360;
        altitude = e.beta;
    }
}

// Toggle deep-sky mode
toggleBtn.addEventListener('click', ()=>{
    showDeepSky = !showDeepSky;
    toggleBtn.textContent = showDeepSky ? 'Toggle Deep Sky' : 'Toggle Visible Sky';
    showMsg(showDeepSky ? 'Deep Sky Mode' : 'Visible Sky Mode');
});

// Draw function
function drawSky(lat, lon){
    const observer = new Astronomy.Observer(lat, lon, 0);
    function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // Crosshair
        ctx.strokeStyle='rgba(255,255,255,0.7)';
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.moveTo(canvas.width/2-15,canvas.height/2);
        ctx.lineTo(canvas.width/2+15,canvas.height/2);
        ctx.moveTo(canvas.width/2,canvas.height/2-15);
        ctx.lineTo(canvas.width/2,canvas.height/2+15);
        ctx.stroke();

        const time = Astronomy.MakeTime(new Date());

        function drawObj(name, ra, dec, size, color){
            const eq = new Astronomy.Equatorial(ra, dec, 1);
            const hor = Astronomy.Horizon(time, observer, eq.ra, eq.dec, 'normal');
            // Always draw, even if Sun is up
            let azDiff = hor.azimuth - azimuth;
            if(azDiff>180) azDiff-=360;
            else if(azDiff<-180) azDiff+=360;
            const altDiff = hor.altitude - altitude;
            const x = canvas.width/2 + (azDiff/fov)*canvas.width;
            const y = canvas.height/2 - (altDiff/fov)*canvas.height;
            if(x>0 && x<canvas.width && y>0 && y<canvas.height){
                // Glow effect
                ctx.shadowBlur=15; ctx.shadowColor=color;
                ctx.beginPath();
                ctx.arc(x,y,size,0,Math.PI*2);
                ctx.fillStyle=color;
                ctx.fill();
                ctx.shadowBlur=0;
                ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke();
                ctx.fillStyle='white'; ctx.font=`${Math.max(12,size/2+4)}px Arial`;
                ctx.fillText(name,x+size+5,y+5);
            }
        }

        // Visible sky objects
        const sunEq = Astronomy.Equator('Sun',time,observer,true,true);
        drawObj('Sun',sunEq.ra,sunEq.dec,25,'rgba(255,255,0,0.9)');
        const moonEq = Astronomy.Equator('Moon',time,observer,true,true);
        drawObj('Moon',moonEq.ra,moonEq.dec,20,'rgba(200,200,255,0.9)');
        stars.forEach(s=>drawObj(s.name,s.ra,s.dec,Math.max(5,10-s.mag),'rgba(0,255,255,0.8)'));

        // Deep-sky objects
        if(showDeepSky){
            deepSky.forEach(d=>drawObj(d.name,d.ra,d.dec,d.size,'rgba(255,0,0,0.8)'));
        }

        requestAnimationFrame(animate);
    }
    animate();
}

// Start AR
startBtn.addEventListener('click', async ()=>{
    // Hide start button immediately
    startBtn.style.display = 'none';

    // Request camera access
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject = stream;
        video.style.display='block'; // Make the video visible
        toggleBtn.style.display='inline-block';
        showMsg('Point device to the sky to see celestial objects');

        // Geolocation and sensor permissions
        navigator.geolocation.getCurrentPosition(pos=>{
            // Start the AR drawing after getting a location
            drawSky(pos.coords.latitude,pos.coords.longitude);
        }, err=>{
            showMsg('Geolocation failed, defaulting to 0,0');
            drawSky(0,0);
        });

        // Request device orientation permission for iOS 13+
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') {
                window.addEventListener('deviceorientation', handleDeviceOrientation);
            } else {
                showMsg('Motion sensor permission denied.');
            }
        } else {
            // Non-iOS devices, listen immediately
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }

    }catch(e){
        showMsg('Camera access denied');
    }
});
</script>
</body>
</html>
